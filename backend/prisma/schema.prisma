// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum ExpenseStatus {
  PENDING
  PAID
  DELIVERED
}

model Instance {
  id               String              @id @default(uuid())
  name             String              @unique
  status           String
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt
  subscription     Subscription?
  globalSettings   GlobalSettings?
  users            User[]
  roles            Role[]
  projects         Project[]
  projectGroups    ProjectGroup[]
  suppliers        Supplier[]
  biddings         BiddingProcess[]
  globalStockItems GlobalStockItem[]
  purchaseRequests PurchaseRequest[]
  stockRequests    StockRequest[]
  auditLogs        AuditLog[]
}

model Subscription {
  id           String   @id @default(uuid())
  plan         String
  status       String
  startDate    DateTime
  endDate      DateTime?
  billingCycle String
  instanceId   String   @unique
  instance     Instance @relation(fields: [instanceId], references: [id])
}

model GlobalSettings {
  id                  String              @id @default(uuid())
  defaultCompanyName  String
  companyCnpj         String
  userName            String
  language            String
  currencySymbol      String
  instanceId          String              @unique
  instance            Instance            @relation(fields: [instanceId], references: [id])
  certificates        CompanyCertificate[]
}

model CompanyCertificate {
  id               String         @id @default(uuid())
  createdAt        DateTime       @default(now())
  updatedAt        DateTime?      @updatedAt
  createdById      String?
  name             String
  issuer           String
  category         String         @default("OUTROS")
  expirationDate   DateTime?
  status           String
  attachmentUrls   String[]       @default([])
  globalSettingsId String
  globalSettings   GlobalSettings @relation(fields: [globalSettingsId], references: [id])
  createdBy        User?          @relation("UserCertificatesCreated", fields: [createdById], references: [id])
}

model User {
  id            String          @id @default(uuid())
  name          String
  email         String          @unique
  passwordHash  String
  profileImage  String?
  status        String
  createdAt     DateTime        @default(now())
  instanceId    String
  instance      Instance        @relation(fields: [instanceId], references: [id])
  roles         UserRole[]
  projectAccess ProjectMember[]
  createdForecasts MaterialForecast[] @relation("UserForecasts")
  createdSupplyGroups SupplyGroup[] @relation("UserForecastGroups")
  createdLaborPayments LaborPayment[] @relation("UserLaborPayments")
  createdProjectAssets ProjectAsset[] @relation("UserProjectAssets")
  createdJournalEntries JournalEntry[] @relation("UserJournalEntries")
  createdStockMovements StockMovement[] @relation("UserStockMovements")
  createdPlanningTasks PlanningTask[] @relation("UserPlanningTasks")
  createdGlobalStockMovements GlobalStockMovement[] @relation("UserGlobalStockMovements")
  purchaseRequestsCreated PurchaseRequest[] @relation("UserPurchaseRequestsCreated")
  purchaseRequestsProcessed PurchaseRequest[] @relation("UserPurchaseRequestsProcessed")
  stockRequestsCreated StockRequest[] @relation("UserStockRequestsCreated")
  stockRequestsApproved StockRequest[] @relation("UserStockRequestsApproved")
  stockRequestDeliveries StockRequestDelivery[] @relation("UserStockRequestDeliveries")
  notificationRecipients NotificationRecipient[]
  notificationPreferences NotificationPreference[]
  notificationDeliveries NotificationDelivery[]
  // Audit: createdBy relations
  createdProjects         Project[]           @relation("UserProjectsCreated")
  createdProjectExpenses  ProjectExpense[]    @relation("UserProjectExpensesCreated")
  createdWorkItems        WorkItem[]          @relation("UserWorkItemsCreated")
  createdSuppliers        Supplier[]          @relation("UserSuppliersCreated")
  createdBiddings         BiddingProcess[]    @relation("UserBiddingsCreated")
  createdWorkforceMembers WorkforceMember[]   @relation("UserWorkforceMembersCreated")
  createdLaborContracts   LaborContract[]     @relation("UserLaborContractsCreated")
  createdMilestones       Milestone[]         @relation("UserMilestonesCreated")
  createdMeasurements     MeasurementSnapshot[] @relation("UserMeasurementsCreated")
  createdCertificates     CompanyCertificate[] @relation("UserCertificatesCreated")
  createdProjectGroups    ProjectGroup[]      @relation("UserProjectGroupsCreated")
  createdStockItems       StockItem[]         @relation("UserStockItemsCreated")
  createdGlobalStockItems GlobalStockItem[]   @relation("UserGlobalStockItemsCreated")
  // Audit: updatedBy relations
  updatedProjects         Project[]           @relation("UserProjectsUpdated")
  updatedProjectExpenses  ProjectExpense[]    @relation("UserProjectExpensesUpdated")
  updatedWorkItems        WorkItem[]          @relation("UserWorkItemsUpdated")
  updatedSuppliers        Supplier[]          @relation("UserSuppliersUpdated")
  updatedBiddings         BiddingProcess[]    @relation("UserBiddingsUpdated")
  updatedWorkforceMembers WorkforceMember[]   @relation("UserWorkforceMembersUpdated")
  updatedLaborContracts   LaborContract[]     @relation("UserLaborContractsUpdated")
  updatedStockItems       StockItem[]         @relation("UserStockItemsUpdated")
  updatedGlobalStockItems GlobalStockItem[]   @relation("UserGlobalStockItemsUpdated")
  // Audit log
  auditLogs               AuditLog[]          @relation("UserAuditLogs")
}

model Role {
  id             String           @id @default(uuid())
  name           String
  description    String?
  instanceId     String
  instance       Instance         @relation(fields: [instanceId], references: [id])
  users          UserRole[]
  permissions    RolePermission[]
  projectMembers ProjectMember[]
}

model Permission {
  id          String           @id @default(uuid())
  code        String           @unique
  description String?
  roles       RolePermission[]
}

model UserRole {
  id     String @id @default(uuid())
  userId String
  roleId String
  user   User   @relation(fields: [userId], references: [id])
  role   Role   @relation(fields: [roleId], references: [id])

  @@unique([userId, roleId])
}

model RolePermission {
  id           String     @id @default(uuid())
  roleId       String
  permissionId String
  role         Role       @relation(fields: [roleId], references: [id])
  permission   Permission @relation(fields: [permissionId], references: [id])

  @@unique([roleId, permissionId])
}

model ProjectMember {
  id        String   @id @default(uuid())
  userId    String
  projectId String
  roleId    String
  createdAt DateTime @default(now())
  addedById String?
  user      User     @relation(fields: [userId], references: [id])
  project   Project  @relation(fields: [projectId], references: [id])
  assignedRole Role  @relation(fields: [roleId], references: [id])
  @@unique([userId, projectId])
}

model ProjectGroup {
  id          String         @id @default(uuid())
  createdAt   DateTime       @default(now())
  updatedAt   DateTime?      @updatedAt
  parentId    String?
  name        String
  order       Int
  instanceId  String
  createdById String?
  instance    Instance       @relation(fields: [instanceId], references: [id])
  parent      ProjectGroup?  @relation("ProjectGroupParent", fields: [parentId], references: [id])
  children    ProjectGroup[] @relation("ProjectGroupParent")
  projects    Project[]
  createdBy   User?          @relation("UserProjectGroupsCreated", fields: [createdById], references: [id])
}

model Project {
  id                    String                @id @default(uuid())
  createdAt             DateTime              @default(now())
  updatedAt             DateTime?             @updatedAt
  createdById           String?
  updatedById           String?
  groupId               String?
  order                 Int                   @default(0)
  name                  String
  description           String?
  responsavel           String?
  companyName           String
  companyCnpj           String
  location              String
  measurementNumber     Int
  referenceDate         String
  logo                  String?
  bdi                   Float
  contractTotalOverride Float?
  currentTotalOverride  Float?
  strict                Boolean
  printCards            Boolean
  printSubtotals         Boolean
  showSignatures        Boolean
  isArchived            Boolean               @default(false)
  archivedAt            DateTime?
  instanceId            String
  instance              Instance              @relation(fields: [instanceId], references: [id])
  group                 ProjectGroup?         @relation(fields: [groupId], references: [id])
  members               ProjectMember[]
  items                 WorkItem[]
  history               MeasurementSnapshot[]
  assets                ProjectAsset[]
  expenses              ProjectExpense[]
  planning              ProjectPlanning?
  journal               ProjectJournal?
  notifications         Notification[]
  notificationPreferences NotificationPreference[]
  workforce             WorkforceMember[]
  laborContracts        LaborContract[]
  theme                 PDFTheme?
  stockItems            StockItem[]
  globalStockMovements  GlobalStockMovement[]
  stockRequests         StockRequest[]
  createdBy             User?                 @relation("UserProjectsCreated", fields: [createdById], references: [id])
  updatedBy             User?                 @relation("UserProjectsUpdated", fields: [updatedById], references: [id])
}

model Notification {
  id          String                  @id @default(uuid())
  instanceId  String
  projectId   String?
  category    String
  eventType   String
  priority    String                  @default("normal")
  title       String
  body        String
  metadata    Json?
  dedupeKey   String?
  triggeredAt DateTime                @default(now())
  createdAt   DateTime                @default(now())
  project     Project?                @relation(fields: [projectId], references: [id])
  recipients  NotificationRecipient[]
  deliveries  NotificationDelivery[]

  @@index([instanceId, createdAt])
  @@index([projectId, createdAt])
  @@index([dedupeKey])
}

model NotificationRecipient {
  id             String       @id @default(uuid())
  notificationId String
  userId         String
  readAt         DateTime?
  isRead         Boolean      @default(false)
  channelInApp   Boolean      @default(true)
  channelEmail   Boolean      @default(false)
  createdAt      DateTime     @default(now())
  notification   Notification @relation(fields: [notificationId], references: [id], onDelete: Cascade)
  user           User         @relation(fields: [userId], references: [id])

  @@unique([notificationId, userId])
  @@index([userId, createdAt])
  @@index([userId, isRead, createdAt])
}

model NotificationPreference {
  id          String    @id @default(uuid())
  userId      String
  projectId   String?
  category    String
  eventType   String    @default("*")
  channelInApp Boolean  @default(true)
  channelEmail Boolean  @default(false)
  frequency   String    @default("immediate")
  minPriority String    @default("normal")
  isEnabled   Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  user        User      @relation(fields: [userId], references: [id])
  project     Project?  @relation(fields: [projectId], references: [id])

  @@index([userId, projectId])
  @@index([userId, category, eventType])
}

model NotificationDelivery {
  id             String       @id @default(uuid())
  notificationId String
  userId         String
  channel        String
  status         String       @default("pending")
  attempts       Int          @default(0)
  nextAttemptAt  DateTime?
  sentAt         DateTime?
  lastError      String?
  payload        Json?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  notification   Notification @relation(fields: [notificationId], references: [id], onDelete: Cascade)
  user           User         @relation(fields: [userId], references: [id])

  @@index([status, nextAttemptAt])
  @@index([userId, status])
  @@unique([notificationId, userId, channel])
}

model PDFTheme {
  id            String  @id @default(uuid())
  fontFamily    String
  primary       String
  accent        String
  accentText    String
  border        String
  currencySymbol String?
  headerBg      String
  headerText    String
  categoryBg    String
  categoryText  String
  footerBg      String
  footerText    String
  kpiBg         String
  kpiText       String
  projectId     String  @unique
  project       Project @relation(fields: [projectId], references: [id])
}

model WorkItem {
  id                   String    @id @default(uuid())
  createdById          String?
  updatedById          String?
  parentId             String?
  name                 String
  type                 String
  scope                String    @default("wbs")
  wbs                  String
  order                Int
  unit                 String
  cod                  String?
  fonte                String?
  contractQuantity     Float
  unitPrice            Float
  unitPriceNoBdi        Float
  contractTotal        Float
  previousQuantity     Float
  previousTotal        Float
  currentQuantity      Float
  currentTotal         Float
  currentPercentage    Float
  accumulatedQuantity  Float
  accumulatedTotal     Float
  accumulatedPercentage Float
  balanceQuantity      Float
  balanceTotal         Float
  projectId            String
  project              Project   @relation(fields: [projectId], references: [id])
  parent               WorkItem? @relation("WorkItemParent", fields: [parentId], references: [id])
  children             WorkItem[] @relation("WorkItemParent")
  responsibilities     WorkItemResponsibility[]
  laborContractsLegacy LaborContract[] @relation("LaborContractLinkedWorkItem")
  laborContractLinks   LaborContractWorkItem[]
  createdBy            User?          @relation("UserWorkItemsCreated", fields: [createdById], references: [id])
  updatedBy            User?          @relation("UserWorkItemsUpdated", fields: [updatedById], references: [id])
}

model WorkItemResponsibility {
  id                String          @id @default(uuid())
  workItemId        String
  workforceMemberId String
  workItem          WorkItem        @relation(fields: [workItemId], references: [id])
  workforceMember   WorkforceMember @relation(fields: [workforceMemberId], references: [id])

  @@unique([workItemId, workforceMemberId])
}

model MeasurementSnapshot {
  id                String   @id @default(uuid())
  measurementNumber Int
  date              String
  itemsSnapshot     Json
  totals            Json
  createdById       String?
  projectId         String
  project           Project  @relation(fields: [projectId], references: [id])
  createdBy         User?    @relation("UserMeasurementsCreated", fields: [createdById], references: [id])
}

model ProjectAsset {
  id         String  @id @default(uuid())
  name       String
  category   String  @default("DOCUMENTO_DIVERSO")
  fileType   String
  fileSize   Int
  uploadDate String
  data       String
  createdById String?
  projectId  String
  project    Project @relation(fields: [projectId], references: [id])
  createdBy  User?   @relation("UserProjectAssets", fields: [createdById], references: [id])
}

model ProjectExpense {
  id                 String          @id @default(uuid())
  createdAt          DateTime?       @default(now())
  updatedAt          DateTime?       @updatedAt
  createdById        String?
  updatedById        String?
  parentId           String?
  type               String
  itemType           String
  wbs                String
  order              Int
  date               String
  description        String
  entityName         String
  unit               String
  quantity           Float
  unitPrice          Float
  amount             Float
  isPaid             Boolean
  status             ExpenseStatus
  paymentDate        String?
  paymentProof       String?
  invoiceDoc         String?
  deliveryDate       String?
  discountValue      Float?
  discountPercentage Float?
  issValue           Float?
  issPercentage      Float?
  linkedWorkItemId   String?
  projectId          String
  project            Project         @relation(fields: [projectId], references: [id])
  parent             ProjectExpense? @relation("ProjectExpenseParent", fields: [parentId], references: [id])
  children           ProjectExpense[] @relation("ProjectExpenseParent")
  createdBy          User?            @relation("UserProjectExpensesCreated", fields: [createdById], references: [id])
  updatedBy          User?            @relation("UserProjectExpensesUpdated", fields: [updatedById], references: [id])
}

model ProjectPlanning {
  id        String  @id @default(uuid())
  schedule  Json?
  projectId String  @unique
  project   Project @relation(fields: [projectId], references: [id])
  tasks     PlanningTask[]
  forecasts MaterialForecast[]
  supplyGroups SupplyGroup[]
  milestones Milestone[]
}

model PlanningTask {
  id               String   @id @default(uuid())
  categoryId       String?
  description      String
  status           String
  isCompleted      Boolean
  dueDate          String
  createdAt        String
  completedAt      String?
  createdById      String?
  projectPlanningId String
  projectPlanning  ProjectPlanning @relation(fields: [projectPlanningId], references: [id])
  createdBy        User?   @relation("UserPlanningTasks", fields: [createdById], references: [id])
}

model MaterialForecast {
  id               String   @id @default(uuid())
  description      String
  calculationMemory String?
  unit             String
  quantityNeeded   Float
  unitPrice        Float
  categoryId       String?
  discountValue    Float?
  discountPercentage Float?
  estimatedDate    String
  purchaseDate     String?
  deliveryDate     String?
  status           String
  isPaid           Boolean
  isCleared        Boolean  @default(false)
  order            Int
  supplierId       String?
  supplyGroupId    String?
  paymentProof     String?
  createdById       String?
  projectPlanningId String
  projectPlanning  ProjectPlanning @relation(fields: [projectPlanningId], references: [id])
  supplier         Supplier? @relation(fields: [supplierId], references: [id])
  supplyGroup      SupplyGroup? @relation(fields: [supplyGroupId], references: [id])
  createdBy        User? @relation("UserForecasts", fields: [createdById], references: [id])

  @@index([supplyGroupId])
}

model SupplyGroup {
  id               String   @id @default(uuid())
  title            String?
  estimatedDate    String
  purchaseDate     String?
  deliveryDate     String?
  status           String
  isPaid           Boolean  @default(false)
  isCleared        Boolean  @default(false)
  supplierId       String?
  paymentProof     String?
  invoiceDoc       String?
  createdById      String?
  projectPlanningId String
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  projectPlanning  ProjectPlanning @relation(fields: [projectPlanningId], references: [id])
  supplier         Supplier? @relation(fields: [supplierId], references: [id])
  createdBy        User? @relation("UserForecastGroups", fields: [createdById], references: [id])
  forecasts        MaterialForecast[]
}

model Milestone {
  id               String   @id @default(uuid())
  title            String
  date             String
  isCompleted      Boolean
  createdById      String?
  updatedById      String?
  projectPlanningId String
  projectPlanning  ProjectPlanning @relation(fields: [projectPlanningId], references: [id])
  createdBy        User?          @relation("UserMilestonesCreated", fields: [createdById], references: [id])
}

model ProjectJournal {
  id        String        @id @default(uuid())
  projectId String        @unique
  project   Project       @relation(fields: [projectId], references: [id])
  entries   JournalEntry[]
}

model JournalEntry {
  id              String   @id @default(uuid())
  timestamp       String
  type            String
  category        String
  title           String
  description     String
  progressPercent Float?
  progressStage   String?
  progressItem    String?
  weatherStatus   String?
  photoUrls       String[]
  createdById     String?
  projectJournalId String
  createdBy       User? @relation("UserJournalEntries", fields: [createdById], references: [id])
  projectJournal  ProjectJournal @relation(fields: [projectJournalId], references: [id])
}

model Supplier {
  id          String   @id @default(uuid())
  createdAt   DateTime @default(now())
  updatedAt   DateTime? @updatedAt
  createdById String?
  updatedById String?
  name        String
  cnpj        String
  contactName String
  email       String
  phone       String
  category    String
  rating      Int
  notes       String
  order       Int
  instanceId  String
  instance    Instance @relation(fields: [instanceId], references: [id])
  createdBy   User?    @relation("UserSuppliersCreated", fields: [createdById], references: [id])
  updatedBy   User?    @relation("UserSuppliersUpdated", fields: [updatedById], references: [id])
  forecasts  MaterialForecast[]
  supplyGroups SupplyGroup[]
  globalStockItems GlobalStockItem[]
  priceHistories PriceHistory[]
  globalStockMovements GlobalStockMovement[]
}

model BiddingProcess {
  id              String   @id @default(uuid())
  createdAt       DateTime @default(now())
  updatedAt       DateTime? @updatedAt
  createdById     String?
  updatedById     String?
  tenderNumber    String
  clientName      String
  object          String
  openingDate     String
  expirationDate  String
  estimatedValue  Float
  ourProposalValue Float
  status          String
  bdi             Float
  itemsSnapshot   Json
  assetsSnapshot  Json
  instanceId      String
  instance        Instance @relation(fields: [instanceId], references: [id])
  createdBy       User?    @relation("UserBiddingsCreated", fields: [createdById], references: [id])
  updatedBy       User?    @relation("UserBiddingsUpdated", fields: [updatedById], references: [id])
}

model WorkforceMember {
  id               String   @id @default(uuid())
  createdAt        DateTime @default(now())
  updatedAt        DateTime? @updatedAt
  createdById      String?
  updatedById      String?
  nome             String
  cpf_cnpj         String
  empresa_vinculada String
  foto             String?
  cargo            String
  projectId        String
  project          Project  @relation(fields: [projectId], references: [id])
  createdBy        User?    @relation("UserWorkforceMembersCreated", fields: [createdById], references: [id])
  updatedBy        User?    @relation("UserWorkforceMembersUpdated", fields: [updatedById], references: [id])
  documentos       StaffDocument[]
  responsabilidades WorkItemResponsibility[]
  laborContracts   LaborContract[]
}

model LaborContract {
  id              String        @id @default(uuid())
  createdAt       DateTime      @default(now())
  updatedAt       DateTime?     @updatedAt
  createdById     String?
  updatedById     String?
  tipo            String
  descricao       String
  associadoId     String
  valorTotal      Float
  valorPago       Float
  status          String
  dataInicio      String
  dataFim         String?
  linkedWorkItemId String?
  observacoes     String?
  ordem           Int
  projectId       String
  project         Project       @relation(fields: [projectId], references: [id])
  associado       WorkforceMember @relation(fields: [associadoId], references: [id])
  linkedWorkItem  WorkItem?     @relation("LaborContractLinkedWorkItem", fields: [linkedWorkItemId], references: [id])
  createdBy       User?         @relation("UserLaborContractsCreated", fields: [createdById], references: [id])
  updatedBy       User?         @relation("UserLaborContractsUpdated", fields: [updatedById], references: [id])
  linkedWorkItems LaborContractWorkItem[]
  pagamentos      LaborPayment[]
}

model LaborContractWorkItem {
  id              String        @id @default(uuid())
  laborContractId String
  workItemId      String
  laborContract   LaborContract @relation(fields: [laborContractId], references: [id])
  workItem        WorkItem      @relation(fields: [workItemId], references: [id])

  @@unique([laborContractId, workItemId])
}

model LaborPayment {
  id              String        @id @default(uuid())
  data            String
  valor           Float
  descricao       String
  comprovante     String?
  createdById     String?
  laborContractId String
  laborContract   LaborContract @relation(fields: [laborContractId], references: [id])
  createdBy       User? @relation("UserLaborPayments", fields: [createdById], references: [id])
}

model StaffDocument {
  id               String   @id @default(uuid())
  nome             String
  dataVencimento   String
  arquivoUrl       String?
  status           String
  workforceMemberId String
  workforceMember  WorkforceMember @relation(fields: [workforceMemberId], references: [id])
}

// --- CONTROLE DE ESTOQUE ---

enum StockMovementType {
  ENTRY
  EXIT
}

model StockItem {
  id              String          @id @default(uuid())
  projectId       String
  name            String
  unit            String          @default("un")
  minQuantity     Float           @default(0)
  currentQuantity Float           @default(0)
  order           Int             @default(0)
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  createdById     String?
  updatedById     String?
  project         Project         @relation(fields: [projectId], references: [id], onDelete: Cascade)
  createdBy       User?           @relation("UserStockItemsCreated", fields: [createdById], references: [id])
  updatedBy       User?           @relation("UserStockItemsUpdated", fields: [updatedById], references: [id])
  movements       StockMovement[]

  @@index([projectId])
}

model StockMovement {
  id          String            @id @default(uuid())
  stockItemId String
  type        StockMovementType
  quantity    Float
  responsible String?
  notes       String            @default("")
  date        DateTime          @default(now())
  createdAt   DateTime          @default(now())
  createdById String?
  createdBy   User?             @relation("UserStockMovements", fields: [createdById], references: [id])
  stockItem   StockItem         @relation(fields: [stockItemId], references: [id], onDelete: Cascade)

  @@index([stockItemId, date(sort: Desc)])
}

// --- ESTOQUE GLOBAL (POR INSTÂNCIA) ---

enum GlobalStockStatus {
  NORMAL
  CRITICAL
  OUT_OF_STOCK
}

enum PurchaseRequestStatus {
  PENDING
  ORDERED
  COMPLETED
  CANCELLED
}

enum PurchaseRequestPriority {
  LOW
  MEDIUM
  HIGH
}

enum StockRequestStatus {
  PENDING
  APPROVED
  PARTIALLY_DELIVERED
  DELIVERED
  REJECTED
  CANCELLED
}

model GlobalStockItem {
  id              String            @id @default(uuid())
  instanceId      String
  name            String
  unit            String            @default("un")
  currentQuantity Float             @default(0)
  minQuantity     Float?
  averagePrice    Float             @default(0)
  lastPrice       Float?
  lastEntryDate   DateTime?
  supplierId      String?
  status          GlobalStockStatus @default(NORMAL)
  order           Int               @default(0)
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  createdById     String?
  updatedById     String?
  instance        Instance          @relation(fields: [instanceId], references: [id])
  supplier        Supplier?         @relation(fields: [supplierId], references: [id])
  createdBy       User?             @relation("UserGlobalStockItemsCreated", fields: [createdById], references: [id])
  updatedBy       User?             @relation("UserGlobalStockItemsUpdated", fields: [updatedById], references: [id])
  priceHistory    PriceHistory[]
  movements       GlobalStockMovement[]
  purchaseRequests PurchaseRequest[]
  stockRequests   StockRequest[]

  @@index([instanceId])
  @@index([instanceId, status])
}

model PriceHistory {
  id                String          @id @default(uuid())
  globalStockItemId String
  date              DateTime        @default(now())
  price             Float
  supplierId        String?
  globalStockItem   GlobalStockItem @relation(fields: [globalStockItemId], references: [id], onDelete: Cascade)
  supplier          Supplier?       @relation(fields: [supplierId], references: [id])

  @@index([globalStockItemId, date(sort: Desc)])
}

model GlobalStockMovement {
  id                String            @id @default(uuid())
  globalStockItemId String
  type              StockMovementType
  quantity          Float
  unitPrice         Float?
  date              DateTime          @default(now())
  responsible       String?
  originDestination String            @default("Depósito Central")
  projectId         String?
  invoiceNumber     String?
  supplierId        String?
  notes             String            @default("")
  createdAt         DateTime          @default(now())
  createdById       String?
  globalStockItem   GlobalStockItem   @relation(fields: [globalStockItemId], references: [id], onDelete: Cascade)
  project           Project?          @relation(fields: [projectId], references: [id])
  supplier          Supplier?         @relation(fields: [supplierId], references: [id])
  createdBy         User?             @relation("UserGlobalStockMovements", fields: [createdById], references: [id])

  @@index([globalStockItemId, date(sort: Desc)])
  @@index([projectId, date(sort: Desc)])
}

model PurchaseRequest {
  id                String                  @id @default(uuid())
  instanceId        String
  globalStockItemId String
  itemName          String
  quantity          Float
  date              DateTime                @default(now())
  status            PurchaseRequestStatus   @default(PENDING)
  priority          PurchaseRequestPriority @default(MEDIUM)
  notes             String?
  requestedById     String
  processedById     String?
  orderedAt         DateTime?
  completedAt       DateTime?
  invoiceNumber     String?
  unitPrice         Float?
  stockRequestId    String?
  createdAt         DateTime                @default(now())
  updatedAt         DateTime                @updatedAt
  instance          Instance                @relation(fields: [instanceId], references: [id])
  globalStockItem   GlobalStockItem         @relation(fields: [globalStockItemId], references: [id], onDelete: Cascade)
  requestedBy       User                    @relation("UserPurchaseRequestsCreated", fields: [requestedById], references: [id])
  processedBy       User?                   @relation("UserPurchaseRequestsProcessed", fields: [processedById], references: [id])
  stockRequest      StockRequest?           @relation(fields: [stockRequestId], references: [id])

  @@index([instanceId, status])
  @@index([globalStockItemId])
  @@index([stockRequestId])
}

model StockRequest {
  id                String             @id @default(uuid())
  instanceId        String
  projectId         String
  globalStockItemId String
  itemName          String
  quantity          Float
  quantityDelivered Float              @default(0)
  date              DateTime           @default(now())
  status            StockRequestStatus @default(PENDING)
  notes             String?
  rejectionReason   String?
  requestedById     String
  approvedById      String?
  approvedAt        DateTime?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  instance          Instance           @relation(fields: [instanceId], references: [id])
  project           Project            @relation(fields: [projectId], references: [id])
  globalStockItem   GlobalStockItem    @relation(fields: [globalStockItemId], references: [id], onDelete: Cascade)
  requestedBy       User               @relation("UserStockRequestsCreated", fields: [requestedById], references: [id])
  approvedBy        User?              @relation("UserStockRequestsApproved", fields: [approvedById], references: [id])
  deliveries        StockRequestDelivery[]
  linkedPurchaseRequests PurchaseRequest[]

  @@index([instanceId, status])
  @@index([projectId, status])
  @@index([globalStockItemId])
}

model StockRequestDelivery {
  id              String       @id @default(uuid())
  stockRequestId  String
  quantity        Float
  date            DateTime     @default(now())
  notes           String?
  createdById     String
  createdAt       DateTime     @default(now())
  stockRequest    StockRequest @relation(fields: [stockRequestId], references: [id], onDelete: Cascade)
  createdBy       User         @relation("UserStockRequestDeliveries", fields: [createdById], references: [id])

  @@index([stockRequestId])
}

// --- LOG DE AUDITORIA ---

model AuditLog {
  id         String   @id @default(cuid())
  instanceId String
  userId     String?
  projectId  String?
  action     String           // CREATE | UPDATE | DELETE
  model      String           // Nome do model (e.g. "Project", "ProjectExpense")
  entityId   String           // ID da entidade afetada
  changes    Json?            // { campo: { from: valorAnterior, to: valorNovo } }
  metadata   Json?            // Dados extras (IP, contexto, etc)
  createdAt  DateTime @default(now())
  instance   Instance @relation(fields: [instanceId], references: [id])
  user       User?    @relation("UserAuditLogs", fields: [userId], references: [id])

  @@index([instanceId, model, entityId])
  @@index([instanceId, createdAt])
  @@index([projectId, createdAt])
  @@index([userId])
}
